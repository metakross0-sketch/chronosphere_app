"""
Flask Backend для приложения с городами, картой и магазинами
"""

from flask import Flask, jsonify, request, send_from_directory
from flask_cors import CORS
import sqlite3
import logging
import os
import uuid
from datetime import datetime
import gspread
from google.oauth2.service_account import Credentials
import requests

app = Flask(__name__)

# CORS: разрешаем запросы с GitHub Pages и локальных тестов
CORS(app, resources={
    r"/*": {
        "origins": [
            "https://metakross0-sketch.github.io",
            "http://localhost:*",
            "http://127.0.0.1:*",
            "*"  # Fallback для других источников
        ],
        "methods": ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
        "allow_headers": ["Content-Type", "Authorization"],
        "supports_credentials": False,
        "max_age": 3600
    }
})

# Настройка
import os
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
DB_PATH = os.path.join(BASE_DIR, 'database.db')
UPLOAD_FOLDER = 'uploads'
GOOGLE_SHEETS_CREDS = os.path.join(BASE_DIR, 'chronosphereapp-7400babccccd.json')
MASTER_SPREADSHEET_ID = '13OZWPfVx5IWvKWOKzvZEwGbDeAuqmku_jGCvpSujpoQ'

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# === ФУНКЦИЯ ДЛЯ БЕЗОПАСНОЙ РАБОТЫ С БД - НЕТ БЛОКИРОВОК ===
def get_db_connection():
    """Создает безопасное соединение с БД"""
    conn = sqlite3.connect(DB_PATH, timeout=30, check_same_thread=False)
    conn.row_factory = sqlite3.Row
    conn.execute('PRAGMA journal_mode=WAL')  # Для concurrent доступа
    return conn

# ==================== GOOGLE SHEETS ====================

def get_shop_spreadsheet_url_by_id(shop_custom_id):
    """Получить ссылку на таблицу магазина из главной таблицы по ID"""
    try:
        scope = [
            'https://spreadsheets.google.com/feeds',
            'https://www.googleapis.com/auth/drive',
            'https://www.googleapis.com/auth/spreadsheets'
        ]
        
        creds = Credentials.from_service_account_file(GOOGLE_SHEETS_CREDS, scopes=scope)
        client = gspread.authorize(creds)
        sheet = client.open_by_key(MASTER_SPREADSHEET_ID).sheet1
        
        # Читаем все строки из главной таблицы (A - дата, B - название, C - ссылка, D - ID)
        data = sheet.get('A2:D1000')
        
        for row in data:
            if len(row) >= 4:
                # row[0] - дата, row[1] - название, row[2] - ссылка, row[3] - ID
                if str(row[3]).strip() == str(shop_custom_id).strip():
                    shop_url = row[2].strip()
                    logger.info(f"✅ Найдена таблица для магазина ID {shop_custom_id}: {shop_url}")
                    return shop_url
        
        logger.warning(f"⚠️ Магазин с ID {shop_custom_id} не найден в главной таблице")
        return None
        
    except Exception as e:
        logger.error(f"❌ Ошибка чтения главной таблицы: {e}")
        return None

def get_google_sheets_data(spreadsheet_id, range_name='A2:J1500'):
    """Получение данных из Google Sheets магазина"""
    try:
        scope = [
            'https://spreadsheets.google.com/feeds',
            'https://www.googleapis.com/auth/drive',
            'https://www.googleapis.com/auth/spreadsheets'
        ]
        
        creds = Credentials.from_service_account_file(GOOGLE_SHEETS_CREDS, scopes=scope)
        client = gspread.authorize(creds)
        sheet = client.open_by_key(spreadsheet_id).sheet1
        
        data = sheet.get(range_name)
        logger.info(f"✅ Получено {len(data)} строк из таблицы {spreadsheet_id}")
        return data
        
    except Exception as e:
        logger.error(f"❌ Ошибка чтения Google Sheets {spreadsheet_id}: {e}")
        return []

def parse_catalog_from_sheets(data):
    """Парсинг данных из Google Sheets в структурированный каталог"""
    catalog = {}
    
    for row in data:
        if len(row) < 6:  # Минимум: раздел, категория, модель, подмодель, цвет, цена
            continue
        
        # Извлекаем данные из строки
        section = row[0].strip() if len(row) > 0 and row[0] else "Без раздела"
        category = row[1].strip() if len(row) > 1 and row[1] else "Без категории"
        model = row[2].strip() if len(row) > 2 and row[2] else "Без модели"
        submodel = row[3].strip() if len(row) > 3 and row[3] else ""
        color = row[4].strip() if len(row) > 4 and row[4] else ""
        price = row[5].strip() if len(row) > 5 and row[5] else "0"
        description = row[6].strip() if len(row) > 6 and row[6] else ""
        sizes = row[7].strip() if len(row) > 7 and row[7] else ""
        photo = row[8].strip() if len(row) > 8 and row[8] else ""
        availability = row[9].strip() if len(row) > 9 and row[9] else "Да"
        
        # Строим структуру каталога
        if section not in catalog:
            catalog[section] = {}
        
        if category not in catalog[section]:
            catalog[section][category] = {}
        
        if model not in catalog[section][category]:
            catalog[section][category][model] = {}
        
        if submodel not in catalog[section][category][model]:
            catalog[section][category][model][submodel] = []
        
        # Добавляем товар
        catalog[section][category][model][submodel].append({
            'color': color,
            'price': price,
            'description': description,
            'sizes': sizes,
            'photo': photo,
            'availability': availability
        })
    
    return catalog

# ==================== ГОРОДА ====================

@app.route('/api/cities', methods=['GET'])
def get_cities():
    """Получить список всех активных городов"""
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT id, name, latitude, longitude, zoom_level, description
            FROM cities
            WHERE is_active = 1
            ORDER BY name
        ''')
        
        cities = []
        for row in cursor.fetchall():
            cities.append({
                'id': row[0],
                'name': row[1],
                'latitude': row[2],
                'longitude': row[3],
                'zoom_level': row[4],
                'description': row[5]
            })
        
        conn.close()
        return jsonify({'success': True, 'cities': cities})
    
    except Exception as e:
        logger.error(f"Ошибка получения городов: {e}")
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/cities/<int:city_id>', methods=['GET'])
def get_city(city_id):
    """Получить информацию о конкретном городе"""
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT id, name, latitude, longitude, zoom_level, description
            FROM cities
            WHERE id = ? AND is_active = 1
        ''', (city_id,))
        
        row = cursor.fetchone()
        conn.close()
        
        if row:
            city = {
                'id': row[0],
                'name': row[1],
                'latitude': row[2],
                'longitude': row[3],
                'zoom_level': row[4],
                'description': row[5]
            }
            return jsonify({'success': True, 'city': city})
        else:
            return jsonify({'success': False, 'error': 'Город не найден'}), 404
    
    except Exception as e:
        logger.error(f"Ошибка получения города: {e}")
        return jsonify({'success': False, 'error': str(e)}), 500

# ==================== МАГАЗИНЫ ====================

@app.route('/api/cities/<int:city_id>/shops', methods=['GET'])
def get_shops_by_city(city_id):
    """Получить все магазины в городе"""
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT 
                s.id, s.name, s.address, s.latitude, s.longitude, 
                s.phone, s.description, s.logo_url, s.working_hours,
                sc.name as category_name, sc.icon as category_icon, sc.color as category_color
            FROM shops s
            LEFT JOIN shop_categories sc ON s.category_id = sc.id
            WHERE s.city_id = ? AND s.is_active = 1
        ''', (city_id,))
        
        shops = []
        for row in cursor.fetchall():
            shops.append({
                'id': row[0],
                'name': row[1],
                'address': row[2],
                'latitude': row[3],
                'longitude': row[4],
                'phone': row[5],
                'description': row[6],
                'logo_url': row[7],
                'working_hours': row[8],
                'category': {
                    'name': row[9],
                    'icon': row[10],
                    'color': row[11]
                }
            })
        
        conn.close()
        return jsonify({'success': True, 'shops': shops})
    
    except Exception as e:
        logger.error(f"Ошибка получения магазинов: {e}")
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/shops/<int:shop_id>', methods=['GET'])
def get_shop(shop_id):
    """Получить информацию о конкретном магазине"""
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT 
                s.id, s.name, s.address, s.latitude, s.longitude, 
                s.phone, s.description, s.logo_url, s.working_hours,
                sc.name as category_name, sc.icon as category_icon, sc.color as category_color,
                c.name as city_name
            FROM shops s
            LEFT JOIN shop_categories sc ON s.category_id = sc.id
            LEFT JOIN cities c ON s.city_id = c.id
            WHERE s.id = ? AND s.is_active = 1
        ''', (shop_id,))
        
        row = cursor.fetchone()
        conn.close()
        
        if row:
            shop = {
                'id': row[0],
                'name': row[1],
                'address': row[2],
                'latitude': row[3],
                'longitude': row[4],
                'phone': row[5],
                'description': row[6],
                'logo_url': row[7],
                'working_hours': row[8],
                'category': {
                    'name': row[9],
                    'icon': row[10],
                    'color': row[11]
                },
                'city_name': row[12]
            }
            return jsonify({'success': True, 'shop': shop})
        else:
            return jsonify({'success': False, 'error': 'Магазин не найден'}), 404
    
    except Exception as e:
        logger.error(f"Ошибка получения магазина: {e}")
        return jsonify({'success': False, 'error': str(e)}), 500

# ==================== КАТАЛОГ МАГАЗИНА ====================

@app.route('/api/shops/<int:shop_id>/catalog', methods=['GET'])
def get_shop_catalog(shop_id):
    """Получить структуру каталога магазина"""
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        
        # Получаем секции
        cursor.execute('''
            SELECT id, name, icon, sort_order
            FROM catalog_sections
            WHERE shop_id = ?
            ORDER BY sort_order, name
        ''', (shop_id,))
        
        sections = []
        for section_row in cursor.fetchall():
            section_id = section_row[0]
            
            # Получаем категории для каждой секции
            cursor.execute('''
                SELECT id, name, icon, sort_order
                FROM catalog_categories
                WHERE section_id = ?
                ORDER BY sort_order, name
            ''', (section_id,))
            
            categories = []
            for cat_row in cursor.fetchall():
                categories.append({
                    'id': cat_row[0],
                    'name': cat_row[1],
                    'icon': cat_row[2]
                })
            
            sections.append({
                'id': section_id,
                'name': section_row[1],
                'icon': section_row[2],
                'categories': categories
            })
        
        conn.close()
        return jsonify({'success': True, 'catalog': sections})
    
    except Exception as e:
        logger.error(f"Ошибка получения каталога: {e}")
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/shops/<int:shop_id>/google-catalog', methods=['GET'])
def get_shop_google_catalog(shop_id):
    """Получить каталог магазина из Google Sheets через главную таблицу"""
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        
        # Получаем custom_id магазина (ваш ID из главной таблицы)
        cursor.execute('''
            SELECT custom_id, name
            FROM shops
            WHERE id = ? AND is_active = 1
        ''', (shop_id,))
        
        shop = cursor.fetchone()
        conn.close()
        
        if not shop:
            return jsonify({'success': False, 'error': 'Магазин не найден'}), 404
        
        custom_id = shop[0]
        shop_name = shop[1]
        
        if not custom_id:
            return jsonify({'success': False, 'error': 'У магазина не указан ID для поиска в главной таблице'}), 404
        
        # Получаем ссылку на таблицу магазина из главной таблицы
        shop_url = get_shop_spreadsheet_url_by_id(custom_id)
        
        if not shop_url:
            return jsonify({'success': False, 'error': f'Таблица для магазина ID {custom_id} не найдена в главной таблице'}), 404
        
        # Извлекаем spreadsheet_id из ссылки
        import re
        match = re.search(r'/spreadsheets/d/([a-zA-Z0-9-_]+)', shop_url)
        if not match:
            return jsonify({'success': False, 'error': 'Некорректная ссылка на таблицу в главной таблице'}), 400
        
        spreadsheet_id = match.group(1)
        
        # Получаем данные из Google Sheets магазина
        data = get_google_sheets_data(spreadsheet_id)
        
        if not data:
            return jsonify({'success': False, 'error': 'Не удалось загрузить данные из таблицы магазина'}), 500
        
        # Парсим каталог
        catalog = parse_catalog_from_sheets(data)
        
        return jsonify({
            'success': True,
            'shop_name': shop_name,
            'shop_custom_id': custom_id,
            'catalog': catalog,
            'total_items': len(data)
        })
        
    except Exception as e:
        logger.error(f"Ошибка получения каталога из Google Sheets: {e}")
        return jsonify({'success': False, 'error': str(e)}), 500


@app.route('/api/categories/<int:category_id>/products', methods=['GET'])
def get_products_by_category(category_id):
    """Получить товары по категории"""
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        
        # Получаем модели
        cursor.execute('''
            SELECT id, name
            FROM catalog_models
            WHERE category_id = ?
            ORDER BY sort_order, name
        ''', (category_id,))
        
        models = []
        for model_row in cursor.fetchall():
            model_id = model_row[0]
            
            # Получаем подмодели
            cursor.execute('''
                SELECT id, name
                FROM catalog_submodels
                WHERE model_id = ?
                ORDER BY sort_order, name
            ''', (model_id,))
            
            submodels = []
            for submodel_row in cursor.fetchall():
                submodel_id = submodel_row[0]
                
                # Получаем товары
                cursor.execute('''
                    SELECT id, name, description, price, old_price, image_url, stock_quantity, is_available
                    FROM products
                    WHERE submodel_id = ?
                    ORDER BY sort_order, name
                ''', (submodel_id,))
                
                products = []
                for prod_row in cursor.fetchall():
                    products.append({
                        'id': prod_row[0],
                        'name': prod_row[1],
                        'description': prod_row[2],
                        'price': prod_row[3],
                        'old_price': prod_row[4],
                        'image_url': prod_row[5],
                        'stock_quantity': prod_row[6],
                        'is_available': prod_row[7]
                    })
                
                submodels.append({
                    'id': submodel_id,
                    'name': submodel_row[1],
                    'products': products
                })
            
            models.append({
                'id': model_id,
                'name': model_row[1],
                'submodels': submodels
            })
        
        conn.close()
        return jsonify({'success': True, 'models': models})
    
    except Exception as e:
        logger.error(f"Ошибка получения товаров: {e}")
        return jsonify({'success': False, 'error': str(e)}), 500

# ==================== ИЗБРАННОЕ ====================

@app.route('/api/favorites', methods=['POST'])
def add_to_favorites():
    """Добавить товар в избранное"""
    try:
        data = request.json
        user_id = data.get('user_id')
        product_id = data.get('product_id')
        
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        
        cursor.execute('''
            INSERT OR IGNORE INTO favorites (user_id, product_id)
            VALUES (?, ?)
        ''', (user_id, product_id))
        
        conn.commit()
        conn.close()
        
        return jsonify({'success': True})
    
    except Exception as e:
        logger.error(f"Ошибка добавления в избранное: {e}")
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/favorites/<int:user_id>', methods=['GET'])
def get_favorites(user_id):
    """Получить избранное пользователя"""
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT p.id, p.name, p.description, p.price, p.old_price, p.image_url
            FROM products p
            INNER JOIN favorites f ON p.id = f.product_id
            WHERE f.user_id = ?
            ORDER BY f.added_at DESC
        ''', (user_id,))
        
        favorites = []
        for row in cursor.fetchall():
            favorites.append({
                'id': row[0],
                'name': row[1],
                'description': row[2],
                'price': row[3],
                'old_price': row[4],
                'image_url': row[5]
            })
        
        conn.close()
        return jsonify({'success': True, 'favorites': favorites})
    
    except Exception as e:
        logger.error(f"Ошибка получения избранного: {e}")
        return jsonify({'success': False, 'error': str(e)}), 500

# ==================== ЧАТ ====================

@app.route('/api/chat/start', methods=['POST'])
def start_chat():
    """Начать новый чат с магазином"""
    try:
        data = request.json
        shop_id = data.get('shop_id')
        user_id = data.get('user_id')
        user_name = data.get('user_name')
        
        session_id = str(uuid.uuid4())
        
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        
        cursor.execute('''
            INSERT INTO shop_chats (shop_id, user_id, user_name, session_id)
            VALUES (?, ?, ?, ?)
        ''', (shop_id, user_id, user_name, session_id))
        
        conn.commit()
        conn.close()
        
        return jsonify({'success': True, 'session_id': session_id})
    
    except Exception as e:
        logger.error(f"Ошибка создания чата: {e}")
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/chat/messages', methods=['POST'])
def send_message():
    """Отправить сообщение в чат"""
    try:
        data = request.json
        session_id = data.get('session_id')
        sender_type = data.get('sender_type')  # 'user' или 'shop'
        sender_name = data.get('sender_name')
        message_text = data.get('message_text')
        
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        
        cursor.execute('''
            INSERT INTO chat_messages (session_id, sender_type, sender_name, message_text)
            VALUES (?, ?, ?, ?)
        ''', (session_id, sender_type, sender_name, message_text))
        
        conn.commit()
        conn.close()
        
        return jsonify({'success': True})
    
    except Exception as e:
        logger.error(f"Ошибка отправки сообщения: {e}")
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/chat/messages/<session_id>', methods=['GET'])
def get_messages(session_id):
    """Получить историю сообщений"""
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT sender_type, sender_name, message_text, created_at
            FROM chat_messages
            WHERE session_id = ?
            ORDER BY created_at ASC
        ''', (session_id,))
        
        messages = []
        for row in cursor.fetchall():
            messages.append({
                'type': row[0],
                'sender_name': row[1],
                'text': row[2],
                'timestamp': row[3]
            })
        
        conn.close()
        return jsonify({'success': True, 'messages': messages})
    
    except Exception as e:
        logger.error(f"Ошибка получения сообщений: {e}")
        return jsonify({'success': False, 'error': str(e)}), 500

# ==================== АДМИН API ====================

@app.route('/api/geocode', methods=['GET'])
def geocode_city():
    """Получить координаты города по названию"""
    try:
        city_name = request.args.get('city')
        if not city_name:
            return jsonify({'success': False, 'error': 'Не указано название города'}), 400
        
        # Используем Nominatim OpenStreetMap для геокодирования
        url = f'https://nominatim.openstreetmap.org/search'
        params = {
            'format': 'json',
            'q': f'{city_name}, Россия',  # Добавляем "Россия" для точности
            'limit': 1,
            'addressdetails': 1
        }
        headers = {
            'User-Agent': 'ShopsApp/1.0',
            'Accept-Language': 'ru'
        }
        
        response = requests.get(url, params=params, headers=headers, timeout=10)
        data = response.json()
        
        if len(data) == 0:
            return jsonify({'success': False, 'error': 'Город не найден'}), 404
        
        result = data[0]
        return jsonify({
            'success': True,
            'latitude': float(result['lat']),
            'longitude': float(result['lon']),
            'display_name': result.get('display_name', city_name)
        })
        
    except Exception as e:
        logger.error(f"Ошибка геокодирования: {e}")
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/admin/cities', methods=['POST'])
def admin_add_city():
    """Добавить новый город"""
    conn = None
    try:
        data = request.json
        conn = get_db_connection()
        cursor = conn.cursor()
        
        cursor.execute('''
            INSERT INTO cities (name, latitude, longitude, zoom_level, description, is_active)
            VALUES (?, ?, ?, ?, ?, 1)
        ''', (data['name'], data['latitude'], data['longitude'], 
              data.get('zoom_level', 12), data.get('description', '')))
        
        conn.commit()
        city_id = cursor.lastrowid
        
        logger.info(f"✅ Город '{data['name']}' добавлен (ID: {city_id})")
        return jsonify({'success': True, 'id': city_id})
        
    except sqlite3.IntegrityError:
        logger.warning(f"⚠️ Город '{data.get('name')}' уже существует")
        return jsonify({'success': False, 'error': 'Город с таким названием уже существует'}), 400
    except Exception as e:
        logger.error(f"❌ Ошибка добавления города: {e}")
        return jsonify({'success': False, 'error': str(e)}), 500
    finally:
        if conn:
            conn.close()

@app.route('/api/admin/cities/<int:city_id>', methods=['DELETE'])
def admin_delete_city(city_id):
    """ПОЛНОЕ УДАЛЕНИЕ ГОРОДА ИЗ БАЗЫ"""
    conn = None
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        # Получаем название города
        cursor.execute('SELECT name FROM cities WHERE id = ?', (city_id,))
        city = cursor.fetchone()
        if not city:
            return jsonify({'success': False, 'error': 'Город не найден'}), 404
        
        city_name = city['name']
        
        # Проверяем есть ли магазины
        cursor.execute('SELECT COUNT(*) as count FROM shops WHERE city_id = ? AND is_active = 1', (city_id,))
        shop_count = cursor.fetchone()['count']
        
        if shop_count > 0:
            # Есть магазины - только деактивируем
            cursor.execute('UPDATE cities SET is_active = 0 WHERE id = ?', (city_id,))
            conn.commit()
            logger.info(f"⚠️ Город '{city_name}' деактивирован (есть {shop_count} магазинов)")
            return jsonify({'success': True, 'message': f'Город деактивирован (есть {shop_count} активных магазинов)'})
        else:
            # Нет магазинов - ПОЛНОСТЬЮ УДАЛЯЕМ НАХУЙ
            cursor.execute('DELETE FROM cities WHERE id = ?', (city_id,))
            conn.commit()
            logger.info(f"✅ Город '{city_name}' ПОЛНОСТЬЮ УДАЛЕН из базы")
            return jsonify({'success': True, 'message': 'Город полностью удален из базы данных'})
            
    except Exception as e:
        logger.error(f"❌ Ошибка удаления города: {e}")
        return jsonify({'success': False, 'error': str(e)}), 500
    finally:
        if conn:
            conn.close()

@app.route('/api/admin/shops', methods=['GET'])
def admin_get_all_shops():
    """Получить все магазины для админки"""
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT 
                s.id, s.name, s.address,
                c.name as city_name,
                sc.name as category_name
            FROM shops s
            LEFT JOIN cities c ON s.city_id = c.id
            LEFT JOIN shop_categories sc ON s.category_id = sc.id
            WHERE s.is_active = 1
            ORDER BY c.name, s.name
        ''')
        
        shops = []
        for row in cursor.fetchall():
            shops.append({
                'id': row[0],
                'name': row[1],
                'address': row[2],
                'city_name': row[3],
                'category_name': row[4]
            })
        
        conn.close()
        return jsonify({'success': True, 'shops': shops})
    except Exception as e:
        logger.error(f"Ошибка получения магазинов: {e}")
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/admin/shops', methods=['POST'])
def admin_add_shop():
    """Добавить новый магазин"""
    try:
        data = request.json
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        
        cursor.execute('''
            INSERT INTO shops 
            (city_id, category_id, name, custom_id, address, latitude, longitude, phone, description, working_hours)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        ''', (data['city_id'], data['category_id'], data['name'], data.get('custom_id', ''),
              data['address'], data['latitude'], data['longitude'], data.get('phone', ''),
              data.get('description', ''), data.get('working_hours', '')))
        
        conn.commit()
        shop_id = cursor.lastrowid
        conn.close()
        
        return jsonify({'success': True, 'id': shop_id})
    except Exception as e:
        logger.error(f"Ошибка добавления магазина: {e}")
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/admin/shops/<int:shop_id>', methods=['DELETE'])
def admin_delete_shop(shop_id):
    """Удалить магазин"""
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        
        cursor.execute('UPDATE shops SET is_active = 0 WHERE id = ?', (shop_id,))
        
        conn.commit()
        conn.close()
        
        return jsonify({'success': True})
    except Exception as e:
        logger.error(f"Ошибка удаления магазина: {e}")
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/admin/categories', methods=['GET'])
def admin_get_categories():
    """Получить все категории"""
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        
        cursor.execute('SELECT id, name, icon, color FROM shop_categories')
        
        categories = []
        for row in cursor.fetchall():
            categories.append({
                'id': row[0],
                'name': row[1],
                'icon': row[2],
                'color': row[3]
            })
        
        conn.close()
        return jsonify({'success': True, 'categories': categories})
    except Exception as e:
        logger.error(f"Ошибка получения категорий: {e}")
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/admin/categories', methods=['POST'])
def admin_add_category():
    """Добавить новую категорию"""
    try:
        data = request.json
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        
        cursor.execute('''
            INSERT INTO shop_categories (name, icon, color)
            VALUES (?, ?, ?)
        ''', (data['name'], data['icon'], data['color']))
        
        conn.commit()
        cat_id = cursor.lastrowid
        conn.close()
        
        return jsonify({'success': True, 'id': cat_id})
    except Exception as e:
        logger.error(f"Ошибка добавления категории: {e}")
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/admin/categories/<int:cat_id>', methods=['DELETE'])
def admin_delete_category(cat_id):
    """Удалить категорию"""
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        
        cursor.execute('DELETE FROM shop_categories WHERE id = ?', (cat_id,))
        
        conn.commit()
        conn.close()
        
        return jsonify({'success': True})
    except Exception as e:
        logger.error(f"Ошибка удаления категории: {e}")
        return jsonify({'success': False, 'error': str(e)}), 500

# ==================== РЕГИСТРАЦИЯ МАГАЗИНОВ ====================

@app.route('/api/shop-registration', methods=['POST'])
def register_shop():
    """Регистрация нового магазина владельцем"""
    try:
        data = request.json
        
        # Валидация обязательных полей
        required_fields = ['name', 'category', 'address', 'city', 'phone', 'sheet_url', 'latitude', 'longitude']
        for field in required_fields:
            if field not in data or not data[field]:
                return jsonify({'success': False, 'error': f'Поле {field} обязательно'}), 400
        
        # Извлекаем ID из ссылки на Google Sheets
        import re
        sheet_match = re.search(r'/spreadsheets/d/([a-zA-Z0-9-_]+)', data['sheet_url'])
        if not sheet_match:
            return jsonify({'success': False, 'error': 'Некорректная ссылка на Google Sheets'}), 400
        
        spreadsheet_id = sheet_match.group(1)
        
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        
        # Создаем таблицу для регистраций, если её нет
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS shop_registrations (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT NOT NULL,
                category TEXT NOT NULL,
                address TEXT NOT NULL,
                city TEXT NOT NULL,
                phone TEXT NOT NULL,
                telegram TEXT,
                sheet_url TEXT NOT NULL,
                spreadsheet_id TEXT NOT NULL,
                latitude REAL NOT NULL,
                longitude REAL NOT NULL,
                description TEXT,
                email TEXT,
                status TEXT DEFAULT 'pending',
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        # Сохраняем регистрацию
        cursor.execute('''
            INSERT INTO shop_registrations 
            (name, category, address, city, phone, telegram, sheet_url, spreadsheet_id, 
             latitude, longitude, description, email)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        ''', (
            data['name'],
            data['category'],
            data['address'],
            data['city'],
            data['phone'],
            data.get('telegram', ''),
            data['sheet_url'],
            spreadsheet_id,
            data['latitude'],
            data['longitude'],
            data.get('description', ''),
            data.get('email', '')
        ))
        
        registration_id = cursor.lastrowid
        
        conn.commit()
        conn.close()
        
        logger.info(f"✅ Новая регистрация магазина: {data['name']} (ID: {registration_id})")
        
        return jsonify({
            'success': True,
            'registration_id': registration_id,
            'message': 'Магазин успешно зарегистрирован и ожидает модерации'
        })
        
    except Exception as e:
        logger.error(f"Ошибка регистрации магазина: {e}")
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/admin/registrations', methods=['GET'])
def get_registrations():
    """Получить список зарегистрированных магазинов для модерации"""
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        
        status = request.args.get('status', 'pending')
        
        cursor.execute('''
            SELECT id, name, category, address, city, phone, telegram, 
                   sheet_url, spreadsheet_id, latitude, longitude, 
                   description, email, status, created_at
            FROM shop_registrations
            WHERE status = ?
            ORDER BY created_at DESC
        ''', (status,))
        
        registrations = []
        for row in cursor.fetchall():
            registrations.append({
                'id': row[0],
                'name': row[1],
                'category': row[2],
                'address': row[3],
                'city': row[4],
                'phone': row[5],
                'telegram': row[6],
                'sheet_url': row[7],
                'spreadsheet_id': row[8],
                'latitude': row[9],
                'longitude': row[10],
                'description': row[11],
                'email': row[12],
                'status': row[13],
                'created_at': row[14]
            })
        
        conn.close()
        
        return jsonify({'registrations': registrations})
    except Exception as e:
        logger.error(f"Ошибка получения регистраций: {e}")
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/admin/registrations/<int:reg_id>/approve', methods=['POST'])
def approve_registration(reg_id):
    """Одобрить регистрацию и создать магазин"""
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        
        # Получаем данные регистрации
        cursor.execute('SELECT * FROM shop_registrations WHERE id = ?', (reg_id,))
        reg = cursor.fetchone()
        
        if not reg:
            return jsonify({'success': False, 'error': 'Регистрация не найдена'}), 404
        
        # Находим или создаем город
        cursor.execute('SELECT id FROM cities WHERE name = ?', (reg[4],))  # city
        city_row = cursor.fetchone()
        
        if not city_row:
            # Создаем новый город
            cursor.execute('''
                INSERT INTO cities (name, latitude, longitude, zoom_level, is_active)
                VALUES (?, ?, ?, ?, ?)
            ''', (reg[4], reg[9], reg[10], 13, 1))  # city, latitude, longitude
            city_id = cursor.lastrowid
        else:
            city_id = city_row[0]
        
        # Находим или создаем категорию
        cursor.execute('SELECT id FROM shop_categories WHERE name = ?', (reg[2],))  # category
        cat_row = cursor.fetchone()
        
        if not cat_row:
            cursor.execute('INSERT INTO shop_categories (name) VALUES (?)', (reg[2],))
            category_id = cursor.lastrowid
        else:
            category_id = cat_row[0]
        
        # Создаем магазин
        cursor.execute('''
            INSERT INTO shops 
            (city_id, name, category_id, address, phone, telegram, 
             latitude, longitude, description, spreadsheet_id, is_active)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        ''', (
            city_id,
            reg[1],  # name
            category_id,
            reg[3],  # address
            reg[5],  # phone
            reg[6],  # telegram
            reg[9],  # latitude
            reg[10],  # longitude
            reg[11],  # description
            reg[8],  # spreadsheet_id
            1  # is_active
        ))
        
        shop_id = cursor.lastrowid
        
        # Обновляем статус регистрации
        cursor.execute('''
            UPDATE shop_registrations 
            SET status = 'approved' 
            WHERE id = ?
        ''', (reg_id,))
        
        conn.commit()
        conn.close()
        
        logger.info(f"✅ Регистрация одобрена: {reg[1]} (Магазин ID: {shop_id})")
        
        return jsonify({
            'success': True,
            'shop_id': shop_id,
            'message': 'Магазин успешно создан'
        })
        
    except Exception as e:
        logger.error(f"Ошибка одобрения регистрации: {e}")
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/admin/registrations/<int:reg_id>/reject', methods=['POST'])
def reject_registration(reg_id):
    """Отклонить регистрацию"""
    try:
        data = request.json
        reason = data.get('reason', 'Не указана')
        
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        
        cursor.execute('''
            UPDATE shop_registrations 
            SET status = 'rejected' 
            WHERE id = ?
        ''', (reg_id,))
        
        conn.commit()
        conn.close()
        
        logger.info(f"❌ Регистрация отклонена ID: {reg_id}, причина: {reason}")
        
        return jsonify({'success': True, 'message': 'Регистрация отклонена'})
    except Exception as e:
        logger.error(f"Ошибка отклонения регистрации: {e}")
        return jsonify({'success': False, 'error': str(e)}), 500

# ==================== СТАТИКА ====================

@app.route('/')
def index():
    return send_from_directory('.', 'index.html')

@app.route('/<path:path>')
def serve_static(path):
    return send_from_directory('.', path)

if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0', port=5000)
